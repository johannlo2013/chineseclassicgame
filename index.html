<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steal a Material</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Rarity border colors */
        .border-rarity-Common { border-color: #9ca3af; } /* gray-400 */
        .border-rarity-Uncommon { border-color: #22c55e; } /* green-500 */
        .border-rarity-Rare { border-color: #3b82f6; } /* blue-500 */
        .border-rarity-Epic { border-color: #a855f7; } /* purple-500 */
        .border-rarity-Legendary { border-color: #eab308; } /* yellow-500 */

        /* Rarity text colors */
        .text-rarity-Common { color: #9ca3af; }
        .text-rarity-Uncommon { color: #22c55e; }
        .text-rarity-Rare { color: #3b82f6; }
        .text-rarity-Epic { color: #a855f7; }
        .text-rarity-Legendary { color: #eab308; }

        /* Smooth transitions for buttons and modals */
        .btn {
            @apply py-2 px-4 rounded-lg font-semibold shadow-md transition-all duration-200 ease-in-out;
        }
        .btn-primary {
            @apply bg-cyan-500 text-white hover:bg-cyan-600;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white hover:bg-gray-700;
        }
        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        .btn-warning {
            @apply bg-yellow-500 text-black hover:bg-yellow-600;
        }
        .btn-success {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        .btn:disabled {
            @apply bg-gray-700 text-gray-400 cursor-not-allowed;
        }

        /* Modal styles */
        .modal-overlay {
            @apply fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center transition-opacity duration-300;
        }
        .modal-content {
            @apply bg-gray-800 p-6 rounded-lg shadow-2xl transform transition-all duration-300 scale-95 opacity-0;
        }
        .modal-overlay.open {
            @apply opacity-100;
        }
        .modal-overlay.open .modal-content {
            @apply scale-100 opacity-100;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-8">
        
        <!-- Header: Title and Money -->
        <header class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-cyan-400">Steal a Material</h1>
            <div class="text-center">
                <span class="text-lg text-gray-400">Your Money</span>
                <div id="money-display" class="text-4xl font-bold text-green-400">$0</div>
            </div>
        </header>

        <!-- Main Content: Player Base, Rivals, Shop -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Player Base -->
            <section class="lg:col-span-2 space-y-6">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-white">Your Base</h2>
                        <div id="player-lock-status" class="text-lg font-medium"></div>
                    </div>

                    <!-- Player's Block Grid -->
                    <div id="player-base-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <!-- Block slots will be generated by JS -->
                    </div>

                    <!-- Player Actions -->
                    <div class="flex flex-col sm:flex-row gap-4 mt-6">
                        <button id="lock-base-btn" class="btn btn-secondary w-full sm:w-auto">Lock Base</button>
                        <button id="buy-block-btn" class="btn btn-primary w-full sm:w-auto">Buy Random Block ($50)</button>
                    </div>
                </div>

                <!-- Rival Bases Section -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold text-white mb-4">Rival Bases</h2>
                    <div id="rivals-list" class="space-y-4">
                        <!-- Rival entries will be generated by JS -->
                    </div>
                </div>
            </section>

            <!-- Right Column: Log and Settings -->
            <aside class="space-y-6">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-white mb-4">Block Guide</h3>
                    <ul class="space-y-2 text-sm">
                        <li><span class="text-rarity-Common font-semibold">Common</span> (50%)</li>
                        <li><span class="text-rarity-Uncommon font-semibold">Uncommon</span> (25%)</li>
                        <li><span class="text-rarity-Rare font-semibold">Rare</span> (15%)</li>
                        <li><span class="text-rarity-Epic font-semibold">Epic</span> (8%)</li>
                        <li><span class="text-rarity-Legendary font-semibold">Legendary</span> (2%)</li>
                    </ul>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-lg h-96">
                    <h3 class="text-xl font-semibold text-white mb-4">Activity Log</h3>
                    <div id="game-log" class="h-full overflow-y-auto space-y-2 text-sm pr-2">
                        <!-- Log messages will be added here -->
                    </div>
                </div>

                <button id="reset-game-btn" class="btn btn-danger w-full">Reset Game Data</button>
            </aside>

        </main>
    </div>

    <!-- Modal for Steal Attempts -->
    <div id="modal" class="modal-overlay opacity-0 pointer-events-none">
        <div class="modal-content w-full max-w-md text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-lg mb-6"></p>
            <button id="modal-close-btn" class="btn btn-primary">Got it</button>
        </div>
    </div>

    <script>
        // --- GAME DATA (The "JSON File") ---
        const BLOCK_DEFS = {
            // Common
            'c1': { name: 'Pebble', rarity: 'Common', bps: 1, emoji: '🪨' },
            'c2': { name: 'Dirt Pile', rarity: 'Common', bps: 2, emoji: '🟫' },
            // Uncommon
            'u1': { name: 'Coal Ore', rarity: 'Uncommon', bps: 5, emoji: '⬛' },
            'u2': { name: 'Copper Ore', rarity: 'Uncommon', bps: 7, emoji: '🟧' },
            // Rare
            'r1': { name: 'Iron Ore', rarity: 'Rare', bps: 15, emoji: '⬜' },
            'r2': { name: 'Gold Ore', rarity: 'Rare', bps: 20, emoji: '🟨' },
            // Epic
            'e1': { name: 'Emerald', rarity: 'Epic', bps: 50, emoji: '💚' },
            'e2': { name: 'Ruby', rarity: 'Epic', bps: 75, emoji: '❤️' },
            // Legendary
            'l1': { name: 'Diamond', rarity: 'Legendary', bps: 200, emoji: '💎' },
            'l2': { name: 'Unobtanium', rarity: 'Legendary', bps: 300, emoji: '🌀' },
        };

        const RARITY_WEIGHTS = [
            { id: 'c1', weight: 25 },
            { id: 'c2', weight: 25 },
            { id: 'u1', weight: 12.5 },
            { id: 'u2', weight: 12.5 },
            { id: 'r1', weight: 10 },
            { id: 'r2', weight: 5 },
            { id: 'e1', weight: 5 },
            { id: 'e2', weight: 3 },
            { id: 'l1', weight: 1.5 },
            { id: 'l2', weight: 0.5 },
        ];
        const TOTAL_WEIGHT = RARITY_WEIGHTS.reduce((sum, item) => sum + item.weight, 0);

        // --- GAME CONSTANTS ---
        const MAX_BLOCKS = 6;
        const BUY_COST = 50;
        const SELL_PRICE = 25; // 50% of BUY_COST
        const LOCK_DURATION = 30; // 30 seconds
        const LOCK_COOLDOWN = 5; // 5 seconds
        const STEAL_CHANCE_SUCCESS = 0.4; // 40% chance to succeed
        const STEAL_CHANCE_GET_BLOCK = 0.7; // 70% chance to get a block *if* steal succeeds

        // --- GAME STATE ---
        let player = {};
        let rivals = [];
        let gameInterval;

        // --- DOM ELEMENTS ---
        const moneyDisplay = document.getElementById('money-display');
        const playerBaseGrid = document.getElementById('player-base-grid');
        const playerLockStatus = document.getElementById('player-lock-status');
        const lockBaseBtn = document.getElementById('lock-base-btn');
        const buyBlockBtn = document.getElementById('buy-block-btn');
        const rivalsList = document.getElementById('rivals-list');
        const gameLog = document.getElementById('game-log');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- GAME LOGIC ---

        /** Initializes the game */
        function init() {
            loadGame();
            addLog("Welcome to Block Tycoon!", "info");
            
            // Set up event listeners
            buyBlockBtn.addEventListener('click', buyBlock);
            lockBaseBtn.addEventListener('click', togglePlayerLock);
            resetGameBtn.addEventListener('click', resetGame);
            modalCloseBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            playerBaseGrid.addEventListener('click', handleBaseGridClick);

            // Start the game loop (1 tick per second)
            gameInterval = setInterval(gameTick, 1000);
            updateUI();
        }

        /** Main game tick, runs every second */
        function gameTick() {
            let income = 0;
            // Player income
            player.blocks.forEach(block => {
                income += BLOCK_DEFS[block.id].bps;
            });
            player.money += income;

            // Player lock timer
            updateTimer(player);

            // Rival income and timers
            rivals.forEach(rival => {
                let rivalIncome = 0;
                rival.blocks.forEach(block => {
                    rivalIncome += BLOCK_DEFS[block.id].bps;
                });
                rival.money += rivalIncome;
                updateTimer(rival);
            });
            
            saveGame();
            updateUI();
        }

        /** Handles timer logic for any entity (player or rival) */
        function updateTimer(entity) {
            if (entity.locked) {
                entity.lockTimer--;
                if (entity.lockTimer <= 0) {
                    entity.locked = false;
                    entity.canLock = false; // Start cooldown
                    entity.cooldownTimer = LOCK_COOLDOWN;
                    if (entity === player) {
                        addLog("Your base is now UNLOCKED!", "warning");
                    }
                }
            } else if (!entity.canLock) {
                entity.cooldownTimer--;
                if (entity.cooldownTimer <= 0) {
                    entity.canLock = true;
                }
            }
        }

        /** Updates all UI elements */
        function updateUI() {
            // Update money
            moneyDisplay.textContent = `$${Math.floor(player.money)}`;

            // Update player base
            renderPlayerBase();
            
            // Update lock button
            renderPlayerLock();

            // Update rivals list
            renderRivals();

            // Check buy button
            buyBlockBtn.disabled = player.money < BUY_COST || player.blocks.length >= MAX_BLOCKS;
        }

        /** Renders the player's 6 block slots */
        function renderPlayerBase() {
            playerBaseGrid.innerHTML = '';
            for (let i = 0; i < MAX_BLOCKS; i++) {
                const block = player.blocks[i];
                const slot = document.createElement('div');
                // Increased height to h-40 to make space for sell button
                slot.className = 'h-40 w-full bg-gray-700/50 rounded-lg flex flex-col items-center justify-center p-2 text-center shadow-inner';
                
                if (block) {
                    const def = BLOCK_DEFS[block.id];
                    slot.classList.add('border-2', `border-rarity-${def.rarity}`);
                    slot.innerHTML = `
                        <span class="text-4xl">${def.emoji}</span>
                        <span class="font-bold text-white mt-1">${def.name}</span>
                        <span class="text-sm ${`text-rarity-${def.rarity}`} font-medium">${def.rarity}</span>
                        <span class="text-xs text-green-400 mt-1">+$${def.bps}/sec</span>
                        <button class="btn btn-warning text-xs mt-2 py-1 px-2" data-block-uid="${block.uid}">Sell ($${SELL_PRICE})</button>
                    `;
                } else {
                    slot.classList.add('border-2', 'border-dashed', 'border-gray-600');
                    slot.innerHTML = `<span class="text-gray-500">Empty Slot</span>`;
                }
                playerBaseGrid.appendChild(slot);
            }
        }

        /** Updates the player's lock button and status */
        function renderPlayerLock() {
            if (player.locked) {
                playerLockStatus.textContent = `Locked (${player.lockTimer}s)`;
                playerLockStatus.className = 'text-lg font-medium text-red-500';
                lockBaseBtn.textContent = `Locked (${player.lockTimer}s)`;
                lockBaseBtn.disabled = true;
                lockBaseBtn.className = 'btn bg-gray-700 text-gray-400 cursor-not-allowed w-full sm:w-auto';
            } else if (!player.canLock) {
                playerLockStatus.textContent = `Unlocked (Cooldown ${player.cooldownTimer}s)`;
                playerLockStatus.className = 'text-lg font-medium text-yellow-500';
                lockBaseBtn.textContent = `Cooldown (${player.cooldownTimer}s)`;
                lockBaseBtn.disabled = true;
                lockBaseBtn.className = 'btn bg-gray-700 text-gray-400 cursor-not-allowed w-full sm:w-auto';
            } else {
                playerLockStatus.textContent = 'Unlocked';
                playerLockStatus.className = 'text-lg font-medium text-green-500';
                lockBaseBtn.textContent = 'Lock Base (30s)';
                lockBaseBtn.disabled = false;
                lockBaseBtn.className = 'btn btn-secondary w-full sm:w-auto';
            }
        }

        /** Renders the list of rivals */
        function renderRivals() {
            rivalsList.innerHTML = '';
            rivals.forEach(rival => {
                const rivalEl = document.createElement('div');
                rivalEl.className = 'bg-gray-700/50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0';
                
                let statusText, statusClass;
                if (rival.locked) {
                    statusText = `Locked (${rival.lockTimer}s)`;
                    statusClass = 'text-red-500';
                } else if (!rival.canLock) {
                    statusText = `Cooldown (${rival.cooldownTimer}s)`;
                    statusClass = 'text-yellow-500';
                } else {
                    statusText = 'Unlocked';
                    statusClass = 'text-green-500';
                }

                rivalEl.innerHTML = `
                    <div>
                        <span class="font-semibold text-white text-lg">${rival.name}</span>
                        <span class="text-gray-400 ml-2">(${rival.blocks.length}/${MAX_BLOCKS} blocks)</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-medium ${statusClass}">${statusText}</span>
                        <button class="btn btn-danger text-sm" data-rival-id="${rival.id}" ${rival.locked ? 'disabled' : ''}>
                            Steal a Material
                        </button>
                    </div>
                `;
                rivalsList.appendChild(rivalEl);
            });

            // Add event listeners to new steal buttons
            rivalsList.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', () => attemptSteal(btn.dataset.rivalId));
            });
        }

        /** Player attempts to buy a random block */
        function buyBlock() {
            if (player.money < BUY_COST) {
                addLog("Not enough money to buy a block.", "error");
                return;
            }
            if (player.blocks.length >= MAX_BLOCKS) {
                addLog("Your base is full!", "error");
                return;
            }

            player.money -= BUY_COST;
            const newBlock = getRandomBlock();
            const def = BLOCK_DEFS[newBlock.id];
            player.blocks.push(newBlock);

            addLog(`You bought a ${def.name} (${def.rarity})!`, "success");
            saveGame();
            updateUI();
        }

        /** Toggles the player's base lock */
        function togglePlayerLock() {
            if (player.canLock && !player.locked) {
                player.locked = true;
                player.lockTimer = LOCK_DURATION;
                player.canLock = false;
                addLog("Your base is now LOCKED!", "info");
                saveGame();
                updateUI();
            }
        }

        /** Player attempts to steal from a rival */
        function attemptSteal(rivalId) {
            const rival = rivals.find(r => r.id === rivalId);
            if (!rival) return;

            if (rival.locked) {
                addLog("Cannot steal, rival base is locked.", "error");
                return;
            }
            if (player.blocks.length >= MAX_BLOCKS) {
                addLog("Your base is full! Cannot steal.", "error");
                return;
            }
            if (rival.blocks.length === 0) {
                addLog(`${rival.name}'s base is empty.`, "info");
                return;
            }

            const stealRoll = Math.random();
            if (stealRoll < STEAL_CHANCE_SUCCESS) {
                // Steal succeeded, now check if they get a block
                const getBlockRoll = Math.random();
                if (getBlockRoll < STEAL_CHANCE_GET_BLOCK) {
                    // Success! Steal a random block.
                    const stolenBlockIndex = Math.floor(Math.random() * rival.blocks.length);
                    const stolenBlock = rival.blocks.splice(stolenBlockIndex, 1)[0];
                    player.blocks.push(stolenBlock);
                    
                    const def = BLOCK_DEFS[stolenBlock.id];
                    addLog(`Success! You stole a ${def.name} from ${rival.name}!`, "success");
                    showModal("Steal Successful!", `You stole a ${def.name} (${def.rarity}) from ${rival.name}!`);
                } else {
                    // Succeeded but got nothing
                    addLog(`You broke into ${rival.name}'s base but found nothing to steal.`, "warning");
                    showModal("Steal Failed!", `You broke into ${rival.name}'s base but couldn't grab anything in time.`);
                }
            } else {
                // Steal failed
                addLog(`Your attempt to steal from ${rival.name} failed!`, "error");
                showModal("Steal Failed!", `Your attempt to steal from ${rival.name} failed and you were spotted!`);
            }
            saveGame();
            updateUI();
        }

        /** Sells a block from the player's base */
        function sellBlock(blockUid) {
            const blockIndex = player.blocks.findIndex(b => b.uid === blockUid);
            if (blockIndex > -1) {
                const block = player.blocks[blockIndex];
                const def = BLOCK_DEFS[block.id];

                // Remove block and add money
                player.blocks.splice(blockIndex, 1);
                player.money += SELL_PRICE;

                addLog(`You sold your ${def.name} for $${SELL_PRICE}.`, "success");
                saveGame();
                updateUI(); // Re-render the base
            }
        }

        /** Handles clicks inside the player base grid (for selling) */
        function handleBaseGridClick(e) {
            // Check if the clicked element or its parent is the sell button
            const sellButton = e.target.closest('[data-block-uid]');
            if (sellButton) {
                sellBlock(sellButton.dataset.blockUid);
            }
        }

        /** Gets a new block object based on weighted rarity */
        function getRandomBlock() {
            const rand = Math.random() * TOTAL_WEIGHT;
            let cumulativeWeight = 0;

            for (const item of RARITY_WEIGHTS) {
                cumulativeWeight += item.weight;
                if (rand < cumulativeWeight) {
                    return {
                        id: item.id,
                        uid: crypto.randomUUID() // Unique ID for each block instance
                    };
                }
            }
            // Fallback (shouldn't happen)
            return { id: 'c1', uid: crypto.randomUUID() };
        }

        /** Adds a message to the game log */
        function addLog(message, type = "info") {
            const logEntry = document.createElement('p');
            let colorClass = "text-gray-400";
            if (type === "success") colorClass = "text-green-400";
            if (type === "error") colorClass = "text-red-400";
            if (type === "warning") colorClass = "text-yellow-400";
            if (type === "info") colorClass = "text-cyan-400";
            
            logEntry.className = colorClass;
            logEntry.textContent = `> ${message}`;
            gameLog.appendChild(logEntry);
            // Auto-scroll to bottom
            gameLog.scrollTop = gameLog.scrollHeight;
        }

        /** Shows the modal */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('open');
        }

        /** Hides the modal */
        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.classList.remove('open');
        }

        // --- DATA PERSISTENCE ---

        /** Gets the default state for a new game */
        function getDefaultState() {
            player = {
                money: 100,
                blocks: [],
                locked: false,
                lockTimer: 0,
                canLock: true,
                cooldownTimer: 0
            };
            rivals = [
                {
                    id: 'rival1',
                    name: 'Rival Bot 1',
                    money: 50,
                    blocks: [getRandomBlock(), getRandomBlock()],
                    locked: false,
                    lockTimer: 0,
                    canLock: true,
                    cooldownTimer: 0
                },
                {
                    id: 'rival2',
                    name: 'Rival Bot 2',
                    money: 200,
                    blocks: [getRandomBlock(), getRandomBlock(), getRandomBlock()],
                    locked: false,
                    lockTimer: 0,
                    canLock: true,
                    cooldownTimer: 0
                }
            ];
        }

        /** Saves the game state to localStorage */
        function saveGame() {
            const saveState = {
                player,
                rivals
            };
            localStorage.setItem('blockTycoonSave', JSON.stringify(saveState));
        }

        /** Loads game state from localStorage or sets defaults */
        function loadGame() {
            const savedState = localStorage.getItem('blockTycoonSave');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                player = parsedState.player;
                rivals = parsedState.rivals;
            } else {
                getDefaultState();
            }
        }

        /** Resets the game */
        function resetGame() {
            // Use a custom modal for confirm later if desired, for now 'confirm' is ok but not ideal in iframe
            if (confirm("Are you sure you want to reset your game? All progress will be lost.")) {
                localStorage.removeItem('blockTycoonSave');
                getDefaultState();
                addLog("Game has been reset.", "warning");
                saveGame();
                updateUI();
            }
        }

        // --- START THE GAME ---
        window.addEventListener('load', init);

    </script>
</body>
</html>

